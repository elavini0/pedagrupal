                    <!-- Sección 2: Dinámica Grupal General -->
                    <section class="form-section" id="seccion2">
                        <h3>👥 Dinámica Grupal General</h3>
                        <div class="form-group">
                            <label for="participacionGrupo">¿Cómo es la participación del grupo en las actividades propuestas?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="participacionGrupo" value="muy_activa"> 🔘 Muy activa</label>
                                <label><input type="radio" name="participacionGrupo" value="activa"> 🔘 Activa</label>
                                <label><input type="radio" name="participacionGrupo" value="irregular"> 🔘 Irregular</label>
                                <label><input type="radio" name="participacionGrupo" value="escasa"> 🔘 Escasa</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="vinculosGrupo">¿Se observan vínculos entre los integrantes del grupo?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="vinculosGrupo" value="fuertes"> Vínculos fuertes</label>
                                <label><input type="radio" name="vinculosGrupo" value="moderados"> Vínculos moderados</label>
                                <label><input type="radio" name="vinculosGrupo" value="debiles"> Vínculos débiles</label>
                                <label><input type="radio" name="vinculosGrupo" value="ausentes"> Sin vínculos observables</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dinamicaPredominante">¿Predomina la colaboración, la competencia o la indiferencia?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="dinamicaPredominante" value="colaboracion"> Colaboración</label>
                                <label><input type="radio" name="dinamicaPredominante" value="competencia"> Competencia</label>
                                <label><input type="radio" name="dinamicaPredominante" value="indiferencia"> Indiferencia</label>
                                <label><input type="radio" name="dinamicaPredominante" value="mixta"> Mixta</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacionesDinamica">Observaciones adicionales sobre la dinámica grupal</label>
                            <textarea id="observacionesDinamica" name="observacionesDinamica" rows="3" placeholder="Detalles específicos sobre la dinámica del grupo..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 3: Comunicación Grupal -->
                    <section class="form-section" id="seccion3">
                        <h3>📣 Comunicación Grupal</h3>
                        <div class="form-group">
                            <label for="canalesComunicativos">¿Qué tipo de canales comunicativos predominan en el grupo?</label>
                            <div class="form-group">
                                <label><input type="checkbox" name="canal_verbal" value="1"> Verbal</label>
                                <label><input type="checkbox" name="canal_gestual" value="1"> Gestual</label>
                                <label><input type="checkbox" name="canal_pictografico" value="1"> Pictográfico</label>
                                <label><input type="checkbox" name="canal_asistido" value="1"> Asistido</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="comprensionConsignas">¿Se comprenden las consignas como colectivo?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="comprensionConsignas" value="siempre"> Siempre</label>
                                <label><input type="radio" name="comprensionConsignas" value="frecuentemente"> Frecuentemente</label>
                                <label><input type="radio" name="comprensionConsignas" value="a_veces"> A veces</label>
                                <label><input type="radio" name="comprensionConsignas" value="raramente"> Raramente</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mediadoresComunicacion">¿Hay personas que median o facilitan la comunicación entre sus pares?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="mediadoresComunicacion" value="si_varios"> Sí, varios integrantes</label>
                                <label><input type="radio" name="mediadoresComunicacion" value="si_algunos"> Sí, algunos integrantes</label>
                                <label><input type="radio" name="mediadoresComunicacion" value="si_uno"> Sí, un integrante</label>
                                <label><input type="radio" name="mediadoresComunicacion" value="no"> No se observa</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacionesComunicacionGrupal">Observaciones adicionales sobre comunicación grupal</label>
                            <textarea id="observacionesComunicacionGrupal" name="observacionesComunicacionGrupal" rows="3" placeholder="Detalles sobre patrones comunicativos del grupo..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 4: Procesos de Aprendizaje Colectivos -->
                    <section class="form-section" id="seccion4">
                        <h3>🧠 Procesos de Aprendizaje Colectivos</h3>
                        <div class="form-group">
                            <label for="contenidosIncorporados">¿Qué contenidos/conceptos se incorporaron de forma significativa?</label>
                            <textarea id="contenidosIncorporados" name="contenidosIncorporados" rows="3" placeholder="Describir los aprendizajes más relevantes del grupo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="autonomiaAprendizaje">¿El grupo transita los procesos de aprendizaje con acompañamiento o de manera más autónoma?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="autonomiaAprendizaje" value="muy_autonomo"> Muy autónomo</label>
                                <label><input type="radio" name="autonomiaAprendizaje" value="autonomo"> Autónomo</label>
                                <label><input type="radio" name="autonomiaAprendizaje" value="acompanamiento_moderado"> Con acompañamiento moderado</label>
                                <label><input type="radio" name="autonomiaAprendizaje" value="acompanamiento_constante"> Requiere acompañamiento constante</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="interesesComunes">¿Se presentan intereses comunes que pueden ser aprovechados pedagógicamente?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="interesesComunes" value="muchos"> Muchos intereses comunes</label>
                                <label><input type="radio" name="interesesComunes" value="algunos"> Algunos intereses comunes</label>
                                <label><input type="radio" name="interesesComunes" value="pocos"> Pocos intereses comunes</label>
                                <label><input type="radio" name="interesesComunes" value="ninguno"> No se observan</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="detalleIntereses">Detalle de intereses comunes identificados</label>
                            <textarea id="detalleIntereses" name="detalleIntereses" rows="3" placeholder="Especificar qué intereses comunes se observaron..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="observacionesAprendizaje">Observaciones adicionales sobre procesos de aprendizaje</label>
                            <textarea id="observacionesAprendizaje" name="observacionesAprendizaje" rows="3" placeholder="Detalles sobre cómo aprende el grupo colectivamente..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 5: Expresión y Creatividad Grupal -->
                    <section class="form-section" id="seccion5">
                        <h3>🎨 Expresión y Creatividad Grupal</h3>
                        <div class="form-group">
                            <label for="apropiacionExpresiva">¿El grupo se apropia de las actividades expresivas como medio de participación?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="apropiacionExpresiva" value="totalmente"> Totalmente</label>
                                <label><input type="radio" name="apropiacionExpresiva" value="mayormente"> Mayormente</label>
                                <label><input type="radio" name="apropiacionExpresiva" value="parcialmente"> Parcialmente</label>
                                <label><input type="radio" name="apropiacionExpresiva" value="poco"> Poco</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="formasCreativas">¿Qué formas creativas destacan?</label>
                            <div class="form-group">
                                <label><input type="checkbox" name="arte_plastico" value="1"> Arte plástico</label>
                                <label><input type="checkbox" name="teatro" value="1"> Teatro</label>
                                <label><input type="checkbox" name="musica" value="1"> Música</label>
                                <label><input type="checkbox" name="movimiento" value="1"> Movimiento</label>
                                <label><input type="checkbox" name="otras_formas" value="1"> Otras formas</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="respuestaImprovision">¿Cómo responden colectivamente ante propuestas abiertas o improvisadas?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="respuestaImprovision" value="muy_positiva"> Muy positivamente</label>
                                <label><input type="radio" name="respuestaImprovision" value="positiva"> Positivamente</label>
                                <label><input type="radio" name="respuestaImprovision" value="variable"> De manera variable</label>
                                <label><input type="radio" name="respuestaImprovision" value="resistencia"> Con resistencia</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacionesCreatividad">Observaciones adicionales sobre expresión y creatividad grupal</label>
                            <textarea id="observacionesCreatividad" name="observacionesCreatividad" rows="3" placeholder="Detalles sobre la expresión creativa del grupo..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 6: Clima Grupal y Emocional -->
                    <section class="form-section" id="seccion6">
                        <h3>⛅ Clima Grupal y Emocional</h3>
                        <div class="form-group">
                            <label for="disposicionInicio">¿Cómo es la disposición emocional grupal al comienzo de la jornada?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="disposicionInicio" value="muy_positiva"> Muy positiva</label>
                                <label><input type="radio" name="disposicionInicio" value="positiva"> Positiva</label>
                                <label><input type="radio" name="disposicionInicio" value="neutral"> Neutral</label>
                                <label><input type="radio" name="disposicionInicio" value="variable"> Variable</label>
                                <label><input type="radio" name="disposicionInicio" value="negativa"> Negativa</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="disposicionCierre">¿Cómo es la disposición emocional grupal al cierre de la jornada?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="disposicionCierre" value="muy_positiva"> Muy positiva</label>
                                <label><input type="radio" name="disposicionCierre" value="positiva"> Positiva</label>
                                <label><input type="radio" name="disposicionCierre" value="neutral"> Neutral</label>
                                <label><input type="radio" name="disposicionCierre" value="variable"> Variable</label>
                                <label><input type="radio" name="disposicionCierre" value="negativa"> Negativa</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="momentosEmocionales">¿Se detectan momentos de tensión o entusiasmo colectivo?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="momentosEmocionales" value="mas_entusiasmo"> Más entusiasmo que tensión</label>
                                <label><input type="radio" name="momentosEmocionales" value="equilibrado"> Equilibrado</label>
                                <label><input type="radio" name="momentosEmocionales" value="mas_tension"> Más tensión que entusiasmo</label>
                                <label><input type="radio" name="momentosEmocionales" value="estable"> Clima estable</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="estrategiasEmocionales">¿Qué estrategias se utilizan para canalizar emociones grupales?</label>
                            <textarea id="estrategiasEmocionales" name="estrategiasEmocionales" rows="3" placeholder="Describir las estrategias utilizadas para manejar el clima emocional..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="observacionesClima">Observaciones adicionales sobre el clima grupal</label>
                            <textarea id="observacionesClima" name="observacionesClima" rows="3" placeholder="Detalles sobre el ambiente emocional del grupo..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 7: Adaptabilidad y Respuesta a lo Inesperado -->
                    <section class="form-section" id="seccion7">
                        <h3>🔄 Adaptabilidad y Respuesta a lo Inesperado</h3>
                        <div class="form-group">
                            <label for="respuestaImprevistos">¿Cómo responde el grupo ante imprevistos?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="respuestaImprevistos" value="muy_flexible"> Muy flexible y adaptable</label>
                                <label><input type="radio" name="respuestaImprevistos" value="flexible"> Flexible</label>
                                <label><input type="radio" name="respuestaImprevistos" value="algo_rigido"> Algo rígido</label>
                                <label><input type="radio" name="respuestaImprevistos" value="muy_rigido"> Muy rígido</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="flexibilidadActividades">¿Muestran flexibilidad para cambiar de actividad o modalidad?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="flexibilidadActividades" value="siempre"> Siempre</label>
                                <label><input type="radio" name="flexibilidadActividades" value="frecuentemente"> Frecuentemente</label>
                                <label><input type="radio" name="flexibilidadActividades" value="a_veces"> A veces</label>
                                <label><input type="radio" name="flexibilidadActividades" value="raramente"> Raramente</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reencuadre">¿Se requiere reencuadrar constantemente las propuestas para sostener el interés colectivo?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="reencuadre" value="nunca"> Nunca</label>
                                <label><input type="radio" name="reencuadre" value="ocasionalmente"> Ocasionalmente</label>
                                <label><input type="radio" name="reencuadre" value="frecuentemente"> Frecuentemente</label>
                                <label><input type="radio" name="reencuadre" value="constantemente"> Constantemente</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacionesAdaptabilidad">Observaciones adicionales sobre adaptabilidad del grupo</label>
                            <textarea id="observacionesAdaptabilidad" name="observacionesAdaptabilidad" rows="3" placeholder="Detalles sobre la capacidad de adaptación del grupo..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 8: Sugerencias y Oportunidades -->
                    <section class="form-section" id="seccion8">
                        <h3>🗣️ Sugerencias y Oportunidades</h3>
                        <div class="form-group">
                            <label for="fortalezasGrupo">Fortalezas del Grupo</label>
                            <textarea id="fortalezasGrupo" name="fortalezasGrupo" rows="4" placeholder="Describir las principales fortalezas observadas en el grupo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="desafiosTrabajar">Desafíos a Trabajar</label>
                            <textarea id="desafiosTrabajar" name="desafiosTrabajar" rows="4" placeholder="Identificar los principales desafíos que presenta el grupo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="recomendacionesPlanificacion">Recomendaciones para la Planificación Pedagógica</label>
                            <textarea id="recomendacionesPlanificacion" name="recomendacionesPlanificacion" rows="4" placeholder="Sugerencias específicas para futuras planificaciones con este grupo..."></textarea>
                        </div>
                    </section>

                    <!-- Navigation Buttons -->
                    <div class="navigation-buttons">
                        <button type="button" id="prevBtn" class="btn btn-secondary">Anterior</button>
                        <button type="button" id="generatePdfBtn" class="btn btn-success">Generar PDF</button>
                        <button type="button" id="nextBtn" class="btn btn-primary">Siguiente</button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script>
// Variables globales
let currentSection = 1;
const totalSections = 8;
let familiarRowCount = 1;

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupEventListeners();
    updateProgress();
    
    // Establecer fecha actual
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha').value = today;
    
    // Cargar datos guardados si existen
    loadFormData();
});

// Configurar event listeners
function setupEventListeners() {
    // Navegación
    document.getElementById('prevBtn').addEventListener('click', previousSection);
    document.getElementById('nextBtn').addEventListener('click', nextSection);
    document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    
    // Navegación por menú lateral
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionNumber = parseInt(this.dataset.section);
            goToSection(sectionNumber);
        });
    });
    
    // Toggle menú móvil
    document.getElementById('navToggle').addEventListener('click', function() {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.toggle('show');
    });
    
    // Auto-guardado
    const formInputs = document.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
        input.addEventListener('change', saveFormData);
        input.addEventListener('input', debounce(saveFormData, 1000));
    });
}

// Inicializar formulario
function initializeForm() {
    showSection(currentSection);
    updateNavigationButtons();
}

// Mostrar sección específica
function showSection(sectionNumber) {
    // Ocultar todas las secciones
    const sections = document.querySelectorAll('.form-section');
    sections.forEach(section => section.classList.remove('active'));
    
    // Mostrar sección actual
    const currentSectionElement = document.getElementById(`seccion${sectionNumber}`);
    if (currentSectionElement) {
        currentSectionElement.classList.add('active');
    }
    
    // Actualizar navegación lateral
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (parseInt(link.dataset.section) === sectionNumber) {
            link.classList.add('active');
        }
    });
    
    currentSection = sectionNumber;
    updateProgress();
    updateNavigationButtons();
    
    // Scroll al top
    document.querySelector('.form-content').scrollTop = 0;
}

// Ir a sección específica
function goToSection(sectionNumber) {
    if (sectionNumber >= 1 && sectionNumber <= totalSections) {
        showSection(sectionNumber);
    }
}

// Sección anterior
function previousSection() {
    if (currentSection > 1) {
        showSection(currentSection - 1);
    }
}

// Sección siguiente
function nextSection() {
    if (currentSection < totalSections) {
        showSection(currentSection + 1);
    }
}

// Actualizar botones de navegación
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    
    prevBtn.style.display = currentSection === 1 ? 'none' : 'inline-block';
    
    if (currentSection === totalSections) {
        nextBtn.style.display = 'none';
        generatePdfBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        generatePdfBtn.style.display = 'none';
    }
}

// Actualizar barra de progreso
function updateProgress() {
    const progressFill = document.getElementById('progressFill');
    const percentage = (currentSection / totalSections) * 100;
    progressFill.style.width = percentage + '%';
}

// Guardar datos del formulario en localStorage
function saveFormData() {
    const formData = new FormData(document.getElementById('historiaClinicaForm'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Guardar también datos de radio buttons y checkboxes
    const radioButtons = document.querySelectorAll('input[type="radio"]:checked');
    radioButtons.forEach(radio => {
        data[radio.name] = radio.value;
    });
    
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        data[checkbox.name] = checkbox.checked;
    });
    
    localStorage.setItem('evaluacionGrupalData', JSON.stringify(data));
}

// Cargar datos del formulario desde localStorage
function loadFormData() {
    const savedData = localStorage.getItem('evaluacionGrupalData');
    if (savedData) {
        const data = JSON.parse(savedData);
        
        for (let [key, value] of Object.entries(data)) {
            const field = document.querySelector(`[name="${key}"]`);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = value;
                } else if (field.type === 'radio') {
                    if (field.value === value) {
                        field.checked = true;
                    }
                } else {
                    field.value = value;
                }
            }
        }
    }
}

// Generar PDF
function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configurar fuente
        doc.setFont('helvetica');
        
        let yPosition = 30;
        const pageHeight = doc.internal.pageSize.height;
        const marginLeft = 20;
        const marginRight = 20;
        const pageWidth = doc.internal.pageSize.width - marginLeft - marginRight;
        
        // Variable para controlar el número de página
        let pageNumber = 1;
        
        // Función para agregar nueva página si es necesario
        function checkPageBreak(neededSpace = 20) {
            if (yPosition + neededSpace > pageHeight - 40) {
                // Agregar numeración a la página actual antes de cambiar
                addPageNumber();
                doc.addPage();
                pageNumber++;
                yPosition = 30;
                // No agregar header en páginas nuevas
            }
        }
        
        // Función para agregar numeración de página
        function addPageNumber() {
            doc.setFontSize(10);
            doc.setTextColor('#666666');
            doc.setFont('helvetica', 'normal');
            doc.text(`Página ${pageNumber}`, doc.internal.pageSize.width / 2, pageHeight - 20, { align: 'center' });
        }
        
        // Función para agregar header simple
        function addSimpleHeader() {
            // Logo centrado
            const logoImg = document.getElementById('logoImage');
            if (logoImg && logoImg.complete) {
                // Crear canvas para convertir imagen a base64
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = logoImg.naturalWidth;
                canvas.height = logoImg.naturalHeight;
                ctx.drawImage(logoImg, 0, 0);
                const logoDataUrl = canvas.toDataURL('image/png');
                
                // Agregar logo centrado al PDF
                const logoWidth = 50;
                const logoHeight = (logoImg.naturalHeight / logoImg.naturalWidth) * logoWidth;
                const logoX = (doc.internal.pageSize.width - logoWidth) / 2;
                doc.addImage(logoDataUrl, 'PNG', logoX, yPosition, logoWidth, logoHeight);
                
                yPosition += logoHeight + 15; // Espacio después del logo
            }
            
            // Título del documento centrado
            doc.setFontSize(18);
            doc.setTextColor('#007bff');
            doc.setFont('helvetica', 'bold');
            const titleText = 'EVALUACIÓN COLECTIVA GRUPAL - RECREARTE';
            const titleWidth = doc.getTextWidth(titleText);
            const titleX = (doc.internal.pageSize.width - titleWidth) / 2;
            doc.text(titleText, titleX, yPosition);
            yPosition += 20;
            
            // Fecha como item separado
            const fecha = document.getElementById('fecha').value;
            doc.setFontSize(12);
            doc.setTextColor('#000000');
            doc.setFont('helvetica', 'normal');
            doc.text(`Fecha: ${fecha}`, marginLeft, yPosition);
            yPosition += 15;
            
            // Línea separadora
            doc.setDrawColor('#e9ecef');
            doc.line(marginLeft, yPosition, pageWidth, yPosition);
            
            yPosition += 20; // Más espacio antes del contenido
        }
        
        // Función para agregar sección
        function addSection(title, content) {
            checkPageBreak(30);
            
            // Título de sección
            doc.setFontSize(13);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor('#007bff');
            doc.text(title, marginLeft, yPosition);
            yPosition += 15;
            
            // Contenido
            doc.setTextColor('#000000');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            if (typeof content === 'object') {
                Object.entries(content).forEach(([key, value]) => {
                    if (value) {
                        checkPageBreak();
                        const text = `${key}: ${value}`;
                        const lines = doc.splitTextToSize(text, pageWidth);
                        lines.forEach(line => {
                            doc.text(line, marginLeft, yPosition);
                            yPosition += 5;
                        });
                    }
                });
            } else if (content) {
                const lines = doc.splitTextToSize(content, pageWidth);
                lines.forEach(line => {
                    checkPageBreak();
                    doc.text(line, marginLeft, yPosition);
                    yPosition += 5;
                });
            }
            
            yPosition += 8;
        }
        
        // Agregar header inicial
        addSimpleHeader();
        
        // Recopilar datos del formulario
        const formData = new FormData(document.getElementById('historiaClinicaForm'));
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Agregar secciones al PDF
        addSection('DATOS DEL GRUPO', {
            'Nombre del Grupo/Taller': data.nombreGrupo,
            'Cantidad de Participantes': data.cantidadParticipantes,
            'Edad Promedio': data.edadPromedio,
            'Docente Evaluador': data.docenteEvaluador,
            'Tipo de Actividad': data.tipoActividad,
            'Observaciones Generales': data.observacionesGeneralesGrupo
        });
        
        addSection('DINÁMICA GRUPAL GENERAL', {
            'Participación del grupo': data.participacionGrupo,
            'Vínculos entre integrantes': data.vinculosGrupo,
            'Dinámica predominante': data.dinamicaPredominante,
            'Observaciones': data.observacionesDinamica
        });
        
        addSection('COMUNICACIÓN GRUPAL', {
            'Canal verbal': data.canal_verbal ? 'Sí' : 'No',
            'Canal gestual': data.canal_gestual ? 'Sí' : 'No',
            'Canal pictográfico': data.canal_pictografico ? 'Sí' : 'No',
            'Canal asistido': data.canal_asistido ? 'Sí' : 'No',
            'Comprensión de consignas': data.comprensionConsignas,
            'Mediadores de comunicación': data.mediadoresComunicacion,
            'Observaciones': data.observacionesComunicacionGrupal
        });
        
        addSection('PROCESOS DE APRENDIZAJE COLECTIVOS', {
            'Contenidos incorporados': data.contenidosIncorporados,
            'Autonomía de aprendizaje': data.autonomiaAprendizaje,
            'Intereses comunes': data.interesesComunes,
            'Detalle de intereses': data.detalleIntereses,
            'Observaciones': data.observacionesAprendizaje
        });
        
        addSection('EXPRESIÓN Y CREATIVIDAD GRUPAL', {
            'Apropiación expresiva': data.apropiacionExpresiva,
            'Arte plástico': data.arte_plastico ? 'Sí' : 'No',
            'Teatro': data.teatro ? 'Sí' : 'No',
            'Música': data.musica ? 'Sí' : 'No',
            'Movimiento': data.movimiento ? 'Sí' : 'No',
            'Otras formas': data.otras_formas ? 'Sí' : 'No',
            'Respuesta a improvisación': data.respuestaImprovision,
            'Observaciones': data.observacionesCreatividad
        });
        
        addSection('CLIMA GRUPAL Y EMOCIONAL', {
            'Disposición al inicio': data.disposicionInicio,
            'Disposición al cierre': data.disposicionCierre,
            'Momentos emocionales': data.momentosEmocionales,
            'Estrategias emocionales': data.estrategiasEmocionales,
            'Observaciones': data.observacionesClima
        });
        
        addSection('ADAPTABILIDAD Y RESPUESTA A LO INESPERADO', {
            'Respuesta a imprevistos': data.respuestaImprevistos,
            'Flexibilidad en actividades': data.flexibilidadActividades,
            'Necesidad de reencuadre': data.reencuadre,
            'Observaciones': data.observacionesAdaptabilidad
        });
        
        addSection('SUGERENCIAS Y OPORTUNIDADES', {
            'Fortalezas del grupo': data.fortalezasGrupo,
            'Desafíos a trabajar': data.desafiosTrabajar,
            'Recomendaciones para planificación': data.recomendacionesPlanificacion
        });
        
        // Firma
        checkPageBreak(30);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('DOCENTE', pageWidth - 50, yPosition);
        
        // Leyenda al final
        checkPageBreak(40);
        yPosition += 30;
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor('#666666');
        const leyenda = 'RECREARTE - Centro Educativo Terapeutico - Funes - Santa Fe';
        const leyendaWidth = doc.getTextWidth(leyenda);
        const centeredX = (doc.internal.pageSize.width - leyendaWidth) / 2;
        doc.text(leyenda, centeredX, yPosition);
        
        // Agregar numeración a la última página
        addPageNumber();
        
        // Guardar PDF
        const nombreGrupo = data.nombreGrupo || 'Evaluacion_Grupal';
        const fechaFormateada = data.fecha || new Date().toISOString().split('T')[0];
        doc.save(`${nombreGrupo}_Evaluacion_Grupal_${fechaFormateada}.pdf`);
        
    } catch (error) {
        console.error('Error generando PDF:', error);
        alert('Error al generar el PDF. Por favor, intente nuevamente.');
    }
}

// Limpiar formulario
function clearForm() {
    if (confirm('¿Está seguro de que desea limpiar todo el formulario? Esta acción no se puede deshacer.')) {
        document.getElementById('historiaClinicaForm').reset();
        
        // Limpiar localStorage
        localStorage.removeItem('evaluacionGrupalData');
        
        // Establecer fecha actual
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
        
        // Volver a la primera sección
        showSection(1);
        
        alert('Formulario limpiado correctamente. Puede comenzar una nueva evaluación grupal.');
    }
}

// Función debounce para optimizar auto-guardado
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
    </script>
</body>
</html>

